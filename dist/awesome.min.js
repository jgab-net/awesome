"use strict";angular.module("netAwesome",[]).directive("netAwesome",["$parse","$timeout","AwesomeService",function(e,t,s){return{restrict:"E",require:"^ngModel",replace:!0,templateUrl:"views/awesome.component.html",controllerAs:"awesome",bindToController:!0,transclude:!0,scope:{placeholder:"@?",base:"@list",filter:"@",childrens:"@",cacheKey:"@",getItem:"&?",limit:"=",alias:"@"},controller:["$scope","$element",function(t,i){this.filter=this.filter||"label",this.placeholder=this.placeholder||"search...",this.select=0,this.cacheKey=this.cacheKey||"_id",this.show=!1,this.father=void 0;var n=this.base.match(/^\s*(\w+)\s+in\s+([\w.]+)\s*$/i);if(!n)throw new Error("list only supports ITEM in COLLECTION syntax.");this.item=n[1],this.list=[{name:void 0,list:s.flatTree(e(n[2])(t.$parent))}],this.active=function(){return this.suggestions[this.select]&&this.suggestions[this.select][this.childrens]?(this.list.push({name:this.suggestions[this.select][this.filter],item:this.suggestions[this.select],list:this.suggestions[this.select][this.childrens]}),!0):!1},this.preAddItem=function(e){return this.list.length>1&&!this.list[this.list.length-1].add?(this.list.push({name:e,list:[],add:!0}),!0):!1},this.deductFather=function(){var e=void 0;if(this.list.length>1){for(var t=void 0,s=this.list.length-1;s>=0;s--)if(this.list[s].item){if(this.list[s].item[this.childrens].length>0){e=this.list[s].item;break}t=t||this.list[s].item}e||(e=this.list[0].list.filter(function(e){return e[this.cacheKey]=t.parent}.bind(this))[0])}return e},this.requestItem=function(){this.getItem({name:this.list[this.list.length-1].name,father:this.father})},this.addItem=function(e){this.list[0].list.push(e),this.father?(this.father[this.childrens].push(e),this.father=void 0):this.list[0].list.filter(function(e){return e[this.cacheKey]=child.parent}.bind(this))[0][this.childrens].push(e)},this.extern={addItem:function(e){if(this.addItem(e),this.list.length>=2)for(var t=this.list.length-1;t>=0;t--)if(this.list[t].item){console.log(this.list[t].item),this.list.splice(t,this.list.length-t,{name:e.label,item:e,list:[]});break}i.find("#preAdd").data("add",!0).modal("hide")}.bind(this)}}],link:function(e,i,n,l,a){e.awesome.alias&&(e.$parent[e.awesome.alias]=e.awesome.extern||{});var o=i.find(".aw-input"),r=i.find(".aw-placeholder"),h=i.find(".aw-list"),c=i.find("#preAdd");c.appendTo(angular.element("body")),e.awesome.cancelFilter=function(s){e.awesome.list.splice(s,this.list.length-s),t(function(){o.focus()})},e.$watchCollection("awesome.suggestions",function(t){if(t){for(var i=function(i){h.append(s.cache.store(t[n][e.awesome.cacheKey],i,o))},n=0,l=t.length;l>n;n++){var o=e.$new(!0);o[e.awesome.item]=t[n],o.$index=n,a(o,i)}s.cache.clearAll()}}),e.$watchCollection("awesome.list",function(t){e.awesome.suggestions=t[t.length-1].list,l.$setViewValue(t.length>1&&t[t.length-1].item?t[t.length-1].item:void 0),e.awesome.select=0}),o.on("input",function(){var t=o.html();e.awesome.show=!0,e.awesome.suggestions=s.filter(e.awesome.list[e.awesome.list.length-1].list,e.awesome.filter,t),e.awesome.select=0,e.$apply()}),o.on("focusin",function(){0!==o.find(".aw-placeholder").length&&(o.html(""),e.awesome.suggestions=s.filter(e.awesome.list[e.awesome.list.length-1].list,e.awesome.filter)),e.awesome.show=!0,e.$apply()}),h.on("mouseenter",function(){e.awesome.hover=!0}),h.on("mouseleave",function(){e.awesome.hover=!1}),o.on("keydown",function(t){var s=t.which||t.keyCode;(13==s||9==s)&&(e.awesome.active()?(t.preventDefault(),o.html("")):""!==o.html()&&angular.isUndefined(n.getItem)===!1?e.awesome.preAddItem(o.html())&&(t.preventDefault(),o.html(""),c.modal("show")):13==s&&t.preventDefault()),40==s?(t.preventDefault(),e.awesome.select=(e.awesome.select+1)%e.awesome.suggestions.length,e.awesome.select>=e.awesome.limit/2?h[0].scrollTop=h[0].scrollTop+angular.element(".aw-item.active").height()+21:0===e.awesome.select&&(h[0].scrollTop=0)):38==s&&(t.preventDefault(),e.awesome.select=e.awesome.select-1>-1?e.awesome.select-1:e.awesome.suggestions.length-1,e.awesome.select===e.awesome.suggestions.length-1?h[0].scrollTop=41*e.awesome.select:e.awesome.select<e.awesome.suggestions.length-1-e.awesome.limit/2&&(h[0].scrollTop=h[0].scrollTop-angular.element(".aw-item.active").height()-21)),8==s&&""===o.html()&&e.awesome.list.length>1&&(t.preventDefault(),e.awesome.list.splice(e.awesome.list.length-1,1)),27==s&&(e.awesome.show=!1),e.$apply()}),o.on("focusout",function(){""===o.html()&&o.append(r),e.awesome.hover||(e.awesome.show=!1,e.$apply())}),c.on("hide.bs.modal",function(){c.data("add")===!1&&(e.awesome.list.splice(e.awesome.list.length-1,1),e.awesome.father=void 0),c.data("add",!1),t(function(){o.focus()})}),c.on("show.bs.modal",function(){e.awesome.father=e.awesome.deductFather()}),e.$watch("awesome.show",function(){e.awesome.show&&h.css({left:i.css("left"),width:i.css("width"),height:41*e.awesome.limit-9+"px"})})}}}]),angular.module("netAwesome").directive("netAwesomeItem",function(){return{restrict:"E",require:"^netAwesome",replace:!0,templateUrl:"views/awesome.item.html",transclude:!0,link:function(e,t,s,i){t.on("mouseenter",function(){i.select=e.$index,e.$apply()}),t.on("click",function(t){i.active()&&e.$apply()})}}}),angular.module("netAwesome").run(["$templateCache",function(e){e.put("views/awesome.component.html",'<div class="awesome form-group">\n  <div ng-class="{\'input-group\': awesome.list.length > 1}">\n    <span\n      class="input-group-addon aw-step"\n      ng-repeat="step in awesome.list"\n      ng-class="{\'aw-item-add\': step.add}"\n      ng-if="$index > 0">\n      {{ step.name }} <i class="glyphicon glyphicon-remove aw-cancel-item" ng-click="awesome.cancelFilter($index)"></i>\n    </span>\n    <div class="aw-input form-control" contenteditable>\n      <div class="aw-placeholder">{{ awesome.placeholder }}</div>\n    </div>\n  </div>\n  <ul class="aw-list list-group" ng-show="awesome.show">\n  </ul>\n  <div class="modal fade" data-add="false" id="preAdd" tabindex="-1" role="dialog" aria-labelledby="add" aria-hidden="true">\n    <div class="modal-dialog">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n          <h4 class="modal-title"> Agregar item</h4>\n        </div>\n        <div class="modal-body">\n          Desea agregar <b>{{ awesome.list[awesome.list.length-1].name }}</b> a <b>{{ awesome.father.label }} </b>\n        </div>\n        <div class="modal-footer">\n          <button type="button" class="btn btn-default" data-dismiss="modal" ng-click="awesome.cancelAdd()">Cancelar</button>\n          <button type="button" class="btn btn-primary" ng-click="awesome.requestItem()">Agregar</button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n'),e.put("views/awesome.item.html",'<li class="list-group-item aw-item" ng-class="{active:$parent.awesome.select == $index, set: $index == 0}">\n    <span ng-transclude></span>\n</li>\n')}]),angular.module("netAwesome").service("AwesomeService",function(){this.flatTree=function(e){return function t(e){for(var s=[],i=0,n=e.length;n>i;i++)s.push(e[i]),e[i].items&&s.push.apply(s,t(e[i].items));return s}(e)},this.filter=function(e,t,s){return s=s||"",e.filter(function(e){return 0===e[t].indexOf(s)})},this.cache={stored:{},store:function(e,t,s){return this.stored[e]&&this.clear(e),this.stored[e]={clone:t,scope:s},this.stored[e].clear=!1,this.stored[e].clone},clear:function(e){this.stored&&(this.stored[e].clone.remove(),this.stored[e].scope.$destroy(),delete this.stored[e])},clearAll:function(){if(this.stored)for(var e in this.stored)this.stored[e].clear?this.clear(e):this.stored[e].clear=!0}}});